---
title: "Data_Science_Final"
author: "Candace Haghighi"
date: "11/22/2017"
output: html_document
---
>Quick Intro... Please make sure that when you type in your section that the code chunk does not push too far down! This will 'bleed' into the next person's section and may cause issues when merging - thank you!!


```{r, Claire section (line 10-110; used for bringing in, cleaning, merging, etc. data)}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(stringr)
library(ggridges)
library(ggthemes)
library(forcats)
library(viridis)
library(plotly)

# cleaning the data
hospital_data = read_csv(file = "./data/Hospital_General_Information.csv", col_names = TRUE) %>% 
  clean_names() %>%
  select(provider_id, hospital_name, city, state, zip_code, hospital_type, hospital_ownership, hospital_overall_rating, patient_experience_national_comparison, location) %>% 
  mutate(hospital_overall_rating = as.numeric(hospital_overall_rating)) %>%
  filter(!is.na(hospital_overall_rating)) %>%
  separate(location, into = c("address", "coordinates"), sep = "\\(") %>% 
  mutate(coordinates = str_sub(coordinates, 1, -2)) %>% 
  separate(coordinates, into = c("Latitudes", "Longitudes"), sep = ",")

# Do not run this code - the `geocode` function takes a long time
hospital_data_missing = read_csv(file = "./data/Hospital_General_Information.csv", col_names = TRUE) %>% 
  clean_names() %>%
  select(provider_id, hospital_name, city, state, zip_code, hospital_type, hospital_ownership, hospital_overall_rating, patient_experience_national_comparison, location) %>% 
  mutate(hospital_overall_rating = as.numeric(hospital_overall_rating)) %>%
  filter(!is.na(hospital_overall_rating)) %>%
  separate(location, into = c("address", "coordinates"), sep = "\\(") %>% 
  mutate(coordinates = str_sub(coordinates, 1, -2)) %>% 
  filter(is.na(coordinates)) %>%
  mutate(coordinates = map(address, ggmap::geocode))

hospital_data_missing_clean <- hospital_data_missing %>% 
  unnest() %>%
  rename(Longitudes = lon, Latitudes = lat)
  
hospital_data_missing_2 <- hospital_data_missing_clean %>% 
  filter(is.na(Longitudes)) %>%
  mutate(coordinates_2 = map(hospital_name, ggmap::geocode))

hospital_data_missing_2_clean <- hospital_data_missing_2 %>% 
  select(everything(), -Longitudes, -Latitudes) %>% 
  unnest() %>%
  rename(Longitudes = lon, Latitudes = lat)

hospital_data_2 <- 
  bind_rows(hospital_data_missing_clean, hospital_data_missing_2_clean) %>%
  drop_na() %>%
  select(c(provider_id:address), Latitudes, Longitudes) %>%
  mutate(Latitudes = as.character(Latitudes),
         Longitudes = as.character(Longitudes)) %>% 
  bind_rows(hospital_data) %>%
  drop_na()

write_csv(hospital_data_2, "./data/hospital_data_2.csv")
hospital_data_2 <- read_csv("./data/hospital_data_2.csv")
```

```{r}
# hospital rating based on hospital type (boxplot)
box_ggplot_type =
hospital_data_2 %>% 
   mutate(hospital_type = fct_reorder(hospital_type, hospital_overall_rating)) %>%
ggplot(aes(x = hospital_type, y = hospital_overall_rating, group = hospital_type)) + geom_boxplot(aes(color = hospital_type)) + labs(title = "Distribution of Hospital Rating Based on Hospital Type", x = "Hospital Type", y = "Hospital Rating") + theme_classic() + theme(axis.text.x = element_text(hjust = 1), plot.title = element_text(hjust = 0.5))
box_ggplot_type

# hospital rating based on ownership (boxplot)
box_ggplot_owner =
hospital_data_2 %>% 
   mutate(hospital_ownership = fct_reorder(hospital_ownership, hospital_overall_rating)) %>%
ggplot(aes(x = hospital_ownership, y = hospital_overall_rating, group = hospital_ownership)) + geom_boxplot(aes(color = hospital_ownership)) + labs(title = "Distribution of Hospital Rating Based on Hospital Ownership", x = "Hospital Ownership", y = "Hospital Rating") + theme_classic() + theme(axis.text.x = element_text(angle = 120, hjust = 1)) + theme(axis.text.x = element_text(hjust = 1), plot.title = element_text(hjust = 0.5))
ggplotly(box_ggplot_owner)


# hospital rating distribution (barplot)
hospital_data_2 %>% 
  mutate(hospital_overall_rating = as.character(hospital_overall_rating)) %>%
  count(hospital_overall_rating) %>% 
  mutate(hospital_overall_rating = fct_reorder(hospital_overall_rating, n)) %>% 
  plot_ly(x = ~hospital_overall_rating, y = ~n, color = ~hospital_overall_rating, type = "bar", colors = "Set2") %>%
   layout(legend = list(x = 100, y = 0.5)) %>%
    layout(
    title = "Distribution of Hospital Rating") %>%
    layout(yaxis = list(title = 'Total number of Hospitals')) %>%
    layout(xaxis = list(title = 'Hospital Rating'))

# hospital rating and Patient Experience Level (Scatter plot)
scatter_patient = hospital_data_2 %>%
  filter(!(patient_experience_national_comparison == "Not Available")) %>%
  ggplot(aes(x = patient_experience_national_comparison, y = hospital_overall_rating, color = hospital_overall_rating)) +
  geom_point(alpha = 0.25) +
  scale_color_viridis() +
  coord_cartesian() + labs(title = "Hospital Rating and Patient Experience level", x = "Patient Experience Level", y = "Hospital Rating") +
  theme_classic()
ggplotly(scatter_patient)
```

##Any additional plots and changes 

```{r, Carolina section 230 - 330 }

library(rvest)
library(httr)


hospitalranks_html <- read_html("https://www.usnews.com/info/blogs/press-room/articles/2016-08-02/us-news-announces-the-201617-best-hospitals")

hospitals <- hospitalranks_html %>% html_nodes(".ad-in-text-target+ .ad-in-text-target h2 , .ad-in-text-target:nth-child(5) li") %>% html_text() %>% data.frame() %>% rename(hospitals = ".") %>% filter(hospitals != "2016â€“17 Best Hospitals Honor Roll")

```

```{r function for scraping hospital rankings from Honor Roll list (can select for different years) when it is arranged in a table with rank, hospital name, and number of points}

honor_roll_scrape <- function(url) {

honor_roll_html <- read_html(url)

rank <- honor_roll_html %>% html_nodes("td:nth-child(1)") %>% html_text() %>% data.frame() %>% rename(rank = ".")

hospital_name <- honor_roll_html %>% html_nodes("td:nth-child(2)") %>% html_text() %>% data.frame() %>% rename(hospital = ".")

points <- honor_roll_html %>% html_nodes("td:nth-child(3)") %>% html_text() %>% data.frame() %>% rename(points = ".") %>% mutate(points = as.numeric(as.character(points))) 

hospitals_honor_roll <- cbind(rank, hospital_name, points)

hospitals_honor_roll <- hospitals_honor_roll[2:21,]
}


```

```{r 2016-2017 Honor Roll hospitals with points}
hospital_honor_roll_2016 <- honor_roll_scrape("https://web.archive.org/web/20160816171510/http://health.usnews.com/health-care/best-hospitals/articles/best-hospitals-honor-roll-and-overview")

#web.archive.org August 16, 2016 
```


```{r}
#2017-2018 Honor Roll rankings, with points (maximum 480)

hospital_honor_roll_2017 <- honor_roll_scrape("https://health.usnews.com/health-care/best-hospitals/articles/best-hospitals-honor-roll-and-overview")

```

```{r}
#Hospital rankings by region--New York region. This first part works. 

ny_hospitalranks_html <- read_html("https://health.usnews.com/best-hospitals/area/new-york-ny")

ny_hospitals <- ny_hospitalranks_html %>% html_nodes(".search-result-link") %>% html_text() %>% data.frame() %>% rename(hospitals = ".") 
```


```{r, Candace section 340 - 440}
##Creating new data set w/ normalized column values for points
hospital_honor_roll_2016_newc = hospital_honor_roll_2016 %>%
##used normalized value (b-a)*(W-c)/(d+c)+a
mutate(new_score = (4 * points/480 + 1)) 

##Create vector
provider_id = c("240010", "360180", "220071", "210009", "050376", "330101", "050454", "140281", "390223", "330214", "260032", "390164", "220110", "050441", "330024", "340030", "050625", "230046", "450358", "060024")

##Add column to hospital_honor_roll_2016
hospital_honor_roll_2016_new <- cbind(hospital_honor_roll_2016_newc, provider_id)

##Merging w/ new column
Merged_dataset <- full_join(hospital_honor_roll_2016_new, hospital_data_2, by = "provider_id")

medicare_hospitals <- Merged_dataset %>% select(hospital, hospital_name, provider_id, hospital_overall_rating) %>% mutate(score = hospital_overall_rating, ranking_type = "medicare") %>% select(hospital, hospital_name, provider_id, score, ranking_type)

usnews_hospitals <- Merged_dataset %>% select(hospital,hospital_name, provider_id, new_score) %>% mutate(score = new_score, ranking_type = "usnews") %>% select(hospital, hospital_name, provider_id, score, ranking_type)

medicare_usnews <- rbind(medicare_hospitals, usnews_hospitals)

# Additional scatterplot - not used
medicare_usnews %>%
  ggplot(aes(x = hospital, y = score, col = ranking_type)) +
  geom_point() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

medicare_usnews %>%
  arrange(desc(score)) %>% 
  mutate(hospital = as.factor(hospital)) %>% 
  ggplot(aes(x = hospital, y = score, fill = ranking_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 70, hjust = 1))

# Creates a chart of the differences between the USNews and Medicare scores
medicare_usnews %>% 
  drop_na() %>% 
  spread(key = ranking_type, value = score) %>%
  mutate(score_diff = usnews - medicare) %>%
  mutate(pos_score_diff = ifelse(score_diff < 0, "Medicare > USNews", "USNews > Medicare")) %>% 
  mutate(hospital = fct_reorder(hospital, score_diff)) %>%
  ggplot(aes(hospital, score_diff, fill = pos_score_diff)) +
  geom_col() +
  coord_flip() +
  ylab("USNews score - Medicare score") +
  scale_fill_discrete(name = "")
```


